<!-- Custom Contact Form (submits to HubSpot) -->
{{ $portalId := .Site.Params.hubspotPortalId }}
{{ $lang := .Site.Language.Lang }}

<form x-data="contactForm('{{ $portalId }}', '{{ $lang }}')" @submit.prevent="submitForm()" class="space-y-4">
  
  <!-- Name -->
  <div>
    <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
      {{ i18n "contact_name" }}
    </label>
    <input 
      type="text"
      id="name"
      x-model="formData.firstname"
      required
      class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors"
      placeholder="{{ i18n "contact_name" }}"
    >
  </div>
  
  <!-- Email -->
  <div>
    <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
      {{ i18n "contact_email" }}
    </label>
    <input 
      type="email"
      id="email"
      x-model="formData.email"
      required
      class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors"
      placeholder="{{ i18n "contact_email" }}"
    >
  </div>
  
  <!-- Message -->
  <div>
    <label for="message" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
      {{ i18n "contact_message" }}
    </label>
    <textarea 
      id="message"
      x-model="formData.message"
      rows="4"
      class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors resize-none"
      placeholder="{{ i18n "contact_message" }}"
    ></textarea>
  </div>
  
  <!-- Submit Button -->
  <div>
    <button 
      type="submit"
      :disabled="isLoading"
      class="w-full px-6 py-3 bg-primary-600 hover:bg-primary-700 disabled:bg-gray-400 text-white font-medium rounded-lg transition-colors"
    >
      <span x-show="!isLoading">{{ i18n "contact_submit" }}</span>
      <span x-show="isLoading" x-cloak>{{ i18n "contact_submit" }}...</span>
    </button>
  </div>
  
  <!-- Success Message -->
  <div x-show="successMessage" x-cloak class="p-3 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 rounded-lg text-sm">
    Thank you! We'll be in touch soon.
  </div>
  
  <!-- Error Message -->
  <div x-show="errorMessage" x-cloak class="p-3 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 rounded-lg text-sm">
    <span x-text="errorMessage"></span>
  </div>
</form>

<script>
  function contactForm(portalId, lang) {
    return {
      formData: {
        firstname: '',
        email: '',
        company: '',
        message: ''
      },
      isLoading: false,
      successMessage: false,
      errorMessage: '',
      
      async submitForm() {
        this.isLoading = true;
        this.errorMessage = '';
        this.successMessage = false;
        
        try {
          // Build HubSpot API payload
          const payload = {
            fields: [
              { name: 'firstname', value: this.formData.firstname },
              { name: 'email', value: this.formData.email },
              { name: 'message', value: this.formData.message },
              { name: 'language', value: lang },
              { name: 'source_page', value: 'openmedgate' }
            ],
            context: {
              pageUri: window.location.href,
              pageName: document.title
            }
          };
          
          // Submit to your backend endpoint (NOT direct to HubSpot)
          const response = await fetch('/api/contact', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          });
          
          if (!response.ok) {
            throw new Error('Submission failed');
          }
          
          // Reset form
          this.formData = {
            firstname: '',
            email: '',
            message: ''
          };
          
          this.successMessage = true;
          
          // Hide success message after 5s
          setTimeout(() => {
            this.successMessage = false;
          }, 5000);
          
        } catch (error) {
          console.error('Form submission error:', error);
          this.errorMessage = 'An error occurred. Please try again.';
        } finally {
          this.isLoading = false;
        }
      }
    }
  }
</script>