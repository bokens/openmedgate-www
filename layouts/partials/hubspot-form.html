<!-- Custom Contact Form (submits directly to HubSpot - no backend) -->
{{ $portalId := .Site.Params.hubspotPortalId }}
{{ $formGuid := .Site.Params.hubspotFormId }}

<form x-data="contactForm('{{ $portalId }}', '{{ $formGuid }}')" @submit.prevent="submitForm()" class="space-y-4 w-full">
  <!-- Email -->
  <div class="w-full overflow-hidden">
    <input type="email" id="email" x-model.trim="formData.email" required
      style="width: 100%;"
      class="px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors"
      placeholder="{{ i18n "contact_email" }}" autocomplete="email">
  </div>

  <!-- Message -->
  <div class="w-full overflow-hidden">
    <textarea id="message" x-model.trim="formData.message" rows="4" required
      style="width: 100%;"
      class="px-3 py-2 sm:px-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors resize-none"
      placeholder="{{ i18n "contact_message" }}" autocomplete="off"></textarea>
  </div>

  <!-- Submit Button -->
  <div class="w-full overflow-hidden">
    <button type="submit" :disabled="isLoading"
      style="width: 100%;"
      class="px-4 py-3 sm:px-6 bg-primary-600 hover:bg-primary-700 disabled:bg-gray-400 text-white font-medium rounded-lg transition-colors">
      <span x-show="!isLoading">{{ i18n "contact_submit" }}</span>
      <span x-show="isLoading" x-cloak>Sending...</span>
    </button>
  </div>

  <!-- Success Message -->
  <div x-show="successMessage" x-cloak class="p-3 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 rounded-lg text-sm">
    Thank you! We'll be in touch soon.
  </div>

  <!-- Error Message -->
  <div x-show="errorMessage" x-cloak class="p-3 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 rounded-lg text-sm">
    <span x-text="errorMessage"></span>
  </div>
</form>

<script>
  function contactForm(portalId, formGuid) {
    return {
      formData: {
        email: '',
        message: ''
      },
      isLoading: false,
      successMessage: false,
      errorMessage: '',

      getHubspotUtk() {
        const m = document.cookie.match(/(?:^|;\s*)hubspotutk=([^;]+)/);
        return m ? decodeURIComponent(m[1]) : null;
      },

      async submitForm() {
        this.errorMessage = '';
        this.successMessage = false;

        if (!this.formData.email || !this.formData.message) {
          this.errorMessage = 'Please fill in all required fields.';
          return;
        }

        this.isLoading = true;

        const payload = {
          fields: [
            { name: "email", value: this.formData.email },
            { name: "message", value: this.formData.message }
          ],
          context: {
            pageUri: window.location.href,
            pageName: document.title,
            hutk: this.getHubspotUtk()
          }
        };

        try {
          const res = await fetch(
            `https://api.hsforms.com/submissions/v3/integration/submit/${portalId}/${formGuid}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            }
          );

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            const msg =
              (data && data.message) ||
              'Submission failed. Please try again or contact us directly.';
            throw new Error(msg);
          }

          this.successMessage = true;
          this.formData.email = '';
          this.formData.message = '';
        } catch (err) {
          this.errorMessage = (err && err.message) ? err.message : 'Something went wrong.';
          console.error('HubSpot submission error:', err);
        } finally {
          this.isLoading = false;
        }
      }
    }
  }
</script>