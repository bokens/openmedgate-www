<!-- Custom Newsletter Form -> HubSpot (no backend) -->
{{ $portalId := .Site.Params.hubspotPortalId }}
{{ $formGuid := .Site.Params.newsletterFormGuid }}

<form x-data="newsletterForm('{{ $portalId }}', '{{ $formGuid }}')" @submit.prevent="submitForm()" class="space-y-4">
  <!-- Email -->
  <div>
    <input
      type="email"
      id="newsletter_email"
      x-model.trim="formData.email"
      required
      class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors"
      placeholder="{{ i18n "contact_email" }}"
      autocomplete="email"
    >
  </div>

  <!-- Submit -->
  <div>
    <button
      type="submit"
      :disabled="isLoading"
      class="w-full px-6 py-3 bg-primary-600 hover:bg-primary-700 disabled:bg-gray-400 text-white font-medium rounded-lg transition-colors"
    >
      <span x-show="!isLoading">{{ i18n "newsletter_submit" }}</span>
      <span x-show="isLoading" x-cloak>{{ i18n "newsletter_submitting" }}</span>
    </button>
  </div>

  <!-- Success -->
  <div x-show="successMessage" x-cloak class="p-3 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 rounded-lg text-sm">
    {{ i18n "newsletter_success" }}
  </div>

  <!-- Error -->
  <div x-show="errorMessage" x-cloak class="p-3 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 rounded-lg text-sm">
    <span x-text="errorMessage"></span>
  </div>
</form>

<script>
  function newsletterForm(portalId, formGuid) {
    return {
      formData: { email: '' },
      isLoading: false,
      successMessage: false,
      errorMessage: '',

      getHubspotUtk() {
        const m = document.cookie.match(/(?:^|;\s*)hubspotutk=([^;]+)/);
        return m ? decodeURIComponent(m[1]) : null;
      },

      async submitForm() {
        this.errorMessage = '';
        this.successMessage = false;

        if (!portalId || !formGuid) {
          this.errorMessage = 'Configuration error: missing HubSpot portalId/formGuid.';
          return;
        }

        this.isLoading = true;

        const payload = {
          fields: [
            { name: "email", value: this.formData.email }
          ],
          context: {
            pageUri: window.location.href,
            pageName: document.title,
            hutk: this.getHubspotUtk()
          }
        };

        try {
          const url = `https://api.hsforms.com/submissions/v3/integration/submit/${portalId}/${formGuid}`;
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            const msg = data?.message || data?.errors?.[0]?.message || 'Subscription failed';
            console.error('HubSpot newsletter error payload:', data);
            throw new Error(msg);
          }

          this.successMessage = true;
          this.formData.email = '';
        } catch (err) {
          this.errorMessage = err?.message || 'Subscription failed';
          console.error('Newsletter submission error:', err);
        } finally {
          this.isLoading = false;
        }
      }
    }
  }
</script>
